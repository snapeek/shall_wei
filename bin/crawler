#!/usr/bin/env ruby

require File.expand_path("../../app/crawlers/weibo_crawl", __FILE__)
require File.expand_path("../../app/crawlers/oops_crawl", __FILE__)
require File.expand_path("../../lib/nlpir", __FILE__)

@oops = OopsCrawl.new
def weibo
  @weibo ||= WeiboCrawl.new
end

def login(username = nil, password = nil)
  # username ||= "xzwyqy@163.com"
  # password ||= "1991lamb"
  @username = username if username
  @password = password if password
  if weibo.login 
    opt = weibo.load_status
    search(opt) if opt
  end
end

def set_delay(_d)
  weibo.delay_times = _d 
end

def s(key_id)
  kw = Keyword.find key_id
  k = kw.kibers.create(
    starttime: kw.starttime,
    crdtime: kw.starttime,
    endtime: kw.endtime,
    gap: 48
  )
  # binding.pry
  search k.id
end

def search(kid)
  k = Kiber.find(kid)
  while true
    break if k.crdtime > k.endtime
    starttime = Time.at(k.crdtime).strftime("%F-%H")
    endtime = Time.at(k.crdtime + k.gap.hours).strftime("%F-%H")
    weibo.search(
      keyword: k.keyword.content, 
      page: k.page , 
      starttime: starttime, 
      endtime: endtime, 
      xsort: false, 
      ori: true,
      kid: kid)
    k.crdtime += k.gap.hours
    k.page = 1
  end
  k.status = k.status | 4
  k.save
end

def news(key_id)
  k = Keyword.find(key_id)
  @oops.crawl_news(k)
end

def dayc(key_id)
  key = Keyword.find(key_id)
  weibo.search_day_count(key)
end

def continue_search
  search(weibo.search_options)
end

puts "
# ==============================================
#
#       登陆      login username, password
#       搜索      search keyword | options
#       设置间隔  set_delay 3..6(default)
#       导出      export 
#       退出      ctrl + c[d] or exit!
#
# ==============================================
" 
pry